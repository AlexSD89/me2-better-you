#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit hooks..."

# Run type checking
echo "ğŸ“ Type checking..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type check failed. Please fix TypeScript errors before committing."
  exit 1
fi

# Run linting
echo "ğŸ§¹ Linting..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Lint check failed. Please fix linting errors before committing."
  exit 1
fi

# Run Prettier formatting check
echo "ğŸ’„ Checking code formatting..."
npx prettier --check .
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting check failed. Running Prettier to fix formatting..."
  npx prettier --write .
  echo "âœ… Code has been formatted. Please review and stage the changes."
  exit 1
fi

# Run tests (if they exist and are configured)
if [ -d "src/__tests__" ] || [ -d "__tests__" ] || ls src/**/*.test.* 1> /dev/null 2>&1; then
  echo "ğŸ§ª Running tests..."
  npm run test -- --watchAll=false --passWithNoTests
  if [ $? -ne 0 ]; then
    echo "âŒ Tests failed. Please fix failing tests before committing."
    exit 1
  fi
fi

# Check for database schema changes
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
  echo "ğŸ“Š Database schema changes detected..."
  echo "âš ï¸  Make sure to run 'npm run db:generate' if you modified the Prisma schema."
  echo "âš ï¸  Consider running 'npm run db:migrate' to create a new migration."
fi

# Check for package.json changes
if git diff --cached --name-only | grep -q "package.json"; then
  echo "ğŸ“¦ package.json changes detected..."
  echo "âš ï¸  Make sure to run 'npm install' to update dependencies."
  
  # Check if package-lock.json is also staged
  if ! git diff --cached --name-only | grep -q "package-lock.json"; then
    echo "âš ï¸  package-lock.json is not staged. This might cause dependency issues."
  fi
fi

# Check for environment file changes
if git diff --cached --name-only | grep -q ".env"; then
  echo "ğŸ”’ Environment file changes detected..."
  echo "âš ï¸  Make sure not to commit sensitive information in .env files."
  echo "âš ï¸  Consider using .env.example for documentation."
fi

# Validate commit message format (if commitizen is configured)
# This is handled by the commit-msg hook

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit!"