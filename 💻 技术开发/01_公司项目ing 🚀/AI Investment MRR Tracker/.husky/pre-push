#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push hooks..."

# Run full test suite
echo "ğŸ§ª Running full test suite..."
npm run test -- --watchAll=false --coverage=false
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Push aborted."
  exit 1
fi

# Build check
echo "ğŸ—ï¸  Testing build..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Push aborted."
  exit 1
fi

# Database migration check (if in production/staging branch)
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" = "main" ] || [ "$current_branch" = "staging" ]; then
  echo "ğŸ“Š Checking database migrations..."
  
  # Check if there are pending migrations
  if npx prisma migrate status 2>&1 | grep -q "Following migration"; then
    echo "âš ï¸  There are pending database migrations."
    echo "âš ï¸  Make sure to run migrations after deployment."
  fi
fi

# Security check for sensitive data
echo "ğŸ”’ Checking for sensitive data..."
if git log --oneline -n 10 | grep -i -E "(password|secret|key|token)" && \
   ! git log --oneline -n 10 | grep -i -E "(remove|delete|hide)"; then
  echo "âš ï¸  Recent commits mention sensitive data keywords."
  echo "âš ï¸  Please ensure no secrets are committed."
fi

# Check for TODO/FIXME in staged files
if git diff origin/main --name-only | xargs grep -l "TODO\|FIXME" 2>/dev/null; then
  echo "âš ï¸  Found TODO/FIXME comments in changed files:"
  git diff origin/main --name-only | xargs grep -n "TODO\|FIXME" 2>/dev/null || true
  echo "âš ï¸  Consider resolving these before pushing to main."
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸŒŸ Ready to push!"