# zhilink-v3 项目架构设计

## 📋 项目概览

**项目名称**: LaunchX智链平台v3  
**定位**: B2B AI能力市场平台  
**核心特色**: 6角色AI协作系统 + 3大产品类型  
**目标用户**: 法律、医疗、电商三大行业的企业客户  

---

## 🎯 技术栈选型

### 前端核心技术

```typescript
// 核心技术栈配置
const TECH_STACK = {
  framework: "Next.js 14",
  runtime: "React 18", 
  language: "TypeScript 5.0+",
  styling: "Tailwind CSS 4.0",
  components: "shadcn/ui + Radix UI",
  stateManagement: "Zustand + TanStack Query",
  animation: "Framer Motion 11+",
  forms: "React Hook Form + Zod",
  testing: "Jest + Testing Library + Playwright",
  build: "Turbopack",
  deployment: "Vercel + Docker"
} as const;
```

### 选型理由

#### **Next.js 14**
- **App Router**: 新的路由系统，支持嵌套布局和流式渲染
- **Server Components**: 默认服务端渲染，优化首屏加载性能
- **Built-in Optimizations**: 图片、字体、脚本优化开箱即用
- **Edge Runtime**: 全球边缘部署支持

#### **React 18**
- **Concurrent Rendering**: 并发渲染提升用户体验
- **Suspense for Data Fetching**: 优雅的加载状态处理
- **Server Components**: 减少客户端JavaScript包大小
- **Automatic Batching**: 自动批处理状态更新

#### **TypeScript 5.0+**
- **Type Safety**: 编译时错误检查，减少运行时bug
- **Developer Experience**: 智能补全和重构支持
- **Enterprise Ready**: 大型项目的代码维护保证

---

## 🏗️ 项目结构

```
zhilink-v3/
├── public/                          # 静态资源
│   ├── images/
│   │   ├── agents/                  # 6角色头像和图标
│   │   ├── products/                # 产品图片
│   │   ├── brands/                  # 品牌和logo
│   │   └── illustrations/           # 插图和装饰图片
│   ├── icons/                       # SVG图标
│   └── fonts/                       # 自定义字体
├── src/
│   ├── app/                         # Next.js 14 App Router
│   │   ├── globals.css              # 全局样式和Tailwind导入
│   │   ├── layout.tsx               # 根布局
│   │   ├── loading.tsx              # 全局加载UI
│   │   ├── error.tsx                # 全局错误页面
│   │   ├── not-found.tsx            # 404页面
│   │   ├── page.tsx                 # 首页
│   │   ├── (auth)/                  # 认证相关页面
│   │   │   ├── login/page.tsx
│   │   │   ├── register/page.tsx
│   │   │   └── layout.tsx
│   │   ├── (platform)/              # 主要平台功能
│   │   │   ├── chat/                # 6角色智能分析
│   │   │   │   ├── page.tsx
│   │   │   │   ├── [sessionId]/page.tsx
│   │   │   │   └── components/
│   │   │   ├── market/              # AI能力市场
│   │   │   │   ├── page.tsx
│   │   │   │   ├── [category]/page.tsx
│   │   │   │   └── components/
│   │   │   ├── product/             # 产品详情
│   │   │   │   ├── [productId]/page.tsx
│   │   │   │   └── components/
│   │   │   ├── dashboard/           # 用户仪表板
│   │   │   │   ├── page.tsx
│   │   │   │   └── components/
│   │   │   └── layout.tsx
│   │   └── api/                     # API路由
│   │       ├── auth/
│   │       ├── chat/
│   │       ├── products/
│   │       └── users/
│   ├── components/                  # 组件库
│   │   ├── ui/                      # 基础UI组件(shadcn/ui)
│   │   │   ├── button.tsx
│   │   │   ├── input.tsx
│   │   │   ├── card.tsx
│   │   │   └── ...
│   │   ├── agents/                  # 6角色相关组件
│   │   │   ├── agent-avatar.tsx
│   │   │   ├── agent-card.tsx
│   │   │   ├── collaboration-view.tsx
│   │   │   └── analysis-progress.tsx
│   │   ├── chat/                    # 聊天相关组件
│   │   │   ├── chat-interface.tsx
│   │   │   ├── message-bubble.tsx
│   │   │   ├── input-panel.tsx
│   │   │   └── suggestion-chips.tsx
│   │   ├── products/                # 产品相关组件
│   │   │   ├── product-card.tsx
│   │   │   ├── product-grid.tsx
│   │   │   ├── filter-sidebar.tsx
│   │   │   └── search-bar.tsx
│   │   ├── layout/                  # 布局组件
│   │   │   ├── header.tsx
│   │   │   ├── sidebar.tsx
│   │   │   ├── footer.tsx
│   │   │   └── breadcrumb.tsx
│   │   └── common/                  # 通用组件
│   │       ├── loading-spinner.tsx
│   │       ├── error-boundary.tsx
│   │       ├── modal.tsx
│   │       └── tooltip.tsx
│   ├── lib/                         # 工具库
│   │   ├── api/                     # API客户端
│   │   │   ├── client.ts            # Axios配置
│   │   │   ├── types.ts             # API类型定义
│   │   │   ├── auth.ts              # 认证相关API
│   │   │   ├── products.ts          # 产品相关API
│   │   │   └── chat.ts              # 聊天相关API
│   │   ├── utils/                   # 通用工具函数
│   │   │   ├── cn.ts                # className合并工具
│   │   │   ├── format.ts            # 格式化工具
│   │   │   ├── validation.ts        # 验证工具
│   │   │   └── constants.ts         # 常量定义
│   │   ├── hooks/                   # 自定义Hooks
│   │   │   ├── use-api.ts           # API请求Hook
│   │   │   ├── use-chat.ts          # 聊天功能Hook
│   │   │   ├── use-agents.ts        # 6角色协作Hook
│   │   │   └── use-auth.ts          # 认证状态Hook
│   │   ├── stores/                  # Zustand状态管理
│   │   │   ├── auth-store.ts        # 认证状态
│   │   │   ├── chat-store.ts        # 聊天状态
│   │   │   ├── agents-store.ts      # 6角色状态
│   │   │   └── ui-store.ts          # UI状态
│   │   └── design-system/           # 设计系统
│   │       ├── colors.ts            # 颜色定义
│   │       ├── typography.ts        # 字体定义
│   │       ├── animations.ts        # 动画定义
│   │       └── tokens.ts            # 设计Token
│   ├── styles/                      # 样式文件
│   │   ├── globals.css              # 全局样式
│   │   ├── cloudsway.css            # Cloudsway设计系统
│   │   └── components.css           # 组件样式
│   └── types/                       # TypeScript类型定义
│       ├── api.ts                   # API类型
│       ├── components.ts            # 组件Props类型
│       ├── agents.ts                # 6角色相关类型
│       └── products.ts              # 产品相关类型
├── docs/                            # 项目文档
├── tests/                           # 测试文件
│   ├── __mocks__/                   # Mock文件
│   ├── components/                  # 组件测试
│   ├── pages/                       # 页面测试
│   └── e2e/                         # E2E测试
├── .env.example                     # 环境变量模板
├── .env.local                       # 本地环境变量
├── next.config.js                   # Next.js配置
├── tailwind.config.ts               # Tailwind配置
├── tsconfig.json                    # TypeScript配置
├── package.json                     # 依赖管理
├── docker-compose.yml               # Docker配置
└── README.md                        # 项目说明
```

---

## 🔄 状态管理架构

### 状态分层设计

```typescript
// 状态管理策略
interface StateArchitecture {
  // 全局状态 (Zustand)
  global: {
    auth: AuthState;
    ui: UIState;
    theme: ThemeState;
  };
  
  // 服务器状态 (TanStack Query)
  server: {
    products: ProductsQuery;
    users: UsersQuery;
    chats: ChatsQuery;
  };
  
  // 本地状态 (React State)
  local: {
    forms: FormState;
    modals: ModalState;
    animations: AnimationState;
  };
}
```

### Zustand Store设计

```typescript
// stores/auth-store.ts
interface AuthState {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  login: (credentials: LoginCredentials) => Promise<void>;
  logout: () => void;
  refreshToken: () => Promise<void>;
}

// stores/agents-store.ts
interface AgentsState {
  currentSession: string | null;
  agents: AgentState[];
  collaborationProgress: CollaborationProgress;
  analysisResults: AnalysisResults | null;
  startAnalysis: (input: UserInput) => void;
  updateAgentProgress: (agentId: string, progress: number) => void;
  completeAnalysis: (results: AnalysisResults) => void;
}
```

---

## 📡 API架构设计

### API客户端配置

```typescript
// lib/api/client.ts
import axios from 'axios';
import { useAuthStore } from '@/lib/stores/auth-store';

const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || '/api',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
apiClient.interceptors.request.use(
  (config) => {
    const { token } = useAuthStore.getState();
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// 响应拦截器
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      const { logout } = useAuthStore.getState();
      logout();
    }
    return Promise.reject(error);
  }
);
```

### API端点设计

```typescript
// 核心API端点
const API_ENDPOINTS = {
  // 认证相关
  auth: {
    login: '/auth/login',
    register: '/auth/register',
    refresh: '/auth/refresh',
    logout: '/auth/logout',
  },
  
  // 6角色分析
  agents: {
    startAnalysis: '/agents/analyze',
    getProgress: '/agents/progress/:sessionId',
    getResults: '/agents/results/:sessionId',
  },
  
  // 产品相关
  products: {
    list: '/products',
    search: '/products/search',
    detail: '/products/:id',
    categories: '/products/categories',
    recommendations: '/products/recommendations',
  },
  
  // 用户相关
  users: {
    profile: '/users/profile',
    preferences: '/users/preferences',
    history: '/users/history',
  },
} as const;
```

---

## ⚡ 性能优化策略

### 代码分割与懒加载

```typescript
// 路由级别的代码分割
const ChatPage = lazy(() => import('@/app/(platform)/chat/page'));
const MarketPage = lazy(() => import('@/app/(platform)/market/page'));
const ProductPage = lazy(() => import('@/app/(platform)/product/[productId]/page'));

// 组件级别的懒加载
const AgentCollaboration = lazy(() => import('@/components/agents/collaboration-view'));
const ProductGrid = lazy(() => import('@/components/products/product-grid'));
```

### 图片优化策略

```typescript
// Next.js Image组件优化配置
const imageConfig = {
  domains: ['res.cloudinary.com', 'cdn.zhilink.com'],
  formats: ['image/webp', 'image/avif'],
  sizes: '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  priority: true, // 首屏图片优先加载
  placeholder: 'blur', // 模糊占位符
};
```

### 缓存策略

```typescript
// TanStack Query缓存配置
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5分钟
      gcTime: 10 * 60 * 1000, // 10分钟
      retry: 2,
      refetchOnWindowFocus: false,
    },
  },
});

// 预加载策略
const prefetchQueries = {
  products: () => queryClient.prefetchQuery({
    queryKey: ['products', 'featured'],
    queryFn: () => api.products.getFeatured(),
  }),
  categories: () => queryClient.prefetchQuery({
    queryKey: ['categories'],
    queryFn: () => api.products.getCategories(),
  }),
};
```

---

## 🔒 安全架构

### 认证与授权

```typescript
// 认证流程
interface SecurityConfig {
  // JWT Token管理
  auth: {
    tokenStorage: 'httpOnly-cookie', // 安全存储
    refreshThreshold: 15 * 60 * 1000, // 15分钟前刷新
    maxRetries: 3,
  };
  
  // API安全
  api: {
    rateLimit: 100, // 每分钟请求限制
    timeout: 10000,
    retries: 2,
  };
  
  // 数据验证
  validation: {
    input: 'zod-schema', // 输入验证
    output: 'runtime-type-check', // 输出验证
    sanitization: true, // XSS防护
  };
}
```

### 数据保护

```typescript
// 敏感数据处理
const securityUtils = {
  // 脱敏处理
  maskSensitiveData: (data: any) => ({
    ...data,
    email: maskEmail(data.email),
    phone: maskPhone(data.phone),
  }),
  
  // 加密存储
  encryptLocalData: (data: any) => 
    CryptoJS.AES.encrypt(JSON.stringify(data), SECRET_KEY).toString(),
  
  // 解密读取
  decryptLocalData: (encryptedData: string) => 
    JSON.parse(CryptoJS.AES.decrypt(encryptedData, SECRET_KEY).toString(CryptoJS.enc.Utf8)),
};
```

---

## 🧪 测试策略

### 测试分层

```typescript
// 测试金字塔
interface TestingStrategy {
  unit: {
    framework: 'Jest + Testing Library';
    coverage: '90%+';
    focus: ['utils', 'hooks', 'stores'];
  };
  
  integration: {
    framework: 'Testing Library + MSW';
    coverage: '80%+';
    focus: ['components', 'pages', 'api'];
  };
  
  e2e: {
    framework: 'Playwright';
    coverage: 'critical-paths';
    focus: ['user-journeys', 'cross-browser'];
  };
}
```

### 测试配置

```typescript
// jest.config.js
const config = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '^~/(.*)$': '<rootDir>/$1',
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.tsx',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

---

## 🚀 部署配置

### Docker化部署

```dockerfile
# Dockerfile
FROM node:18-alpine AS base
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM base AS build
COPY . .
RUN npm run build

FROM base AS runtime
COPY --from=build /app/.next ./.next
COPY --from=build /app/public ./public
EXPOSE 3000
CMD ["npm", "start"]
```

### CI/CD流水线

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production
on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm run test:ci
      - name: Build application
        run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

---

## 📊 监控与维护

### 性能监控

```typescript
// 性能指标收集
const performanceConfig = {
  webVitals: {
    LCP: '<2.5s',    // 最大内容绘制
    FID: '<100ms',   // 首次输入延迟
    CLS: '<0.1',     // 累积布局偏移
    TTFB: '<800ms',  // 首字节时间
  },
  
  customMetrics: {
    chatLoadTime: 'Time to first agent response',
    searchLatency: 'Product search response time',
    analysisSpeed: '6-agent collaboration completion time',
  },
};
```

### 错误监控

```typescript
// 错误边界和日志记录
class ErrorBoundary extends Component {
  static getDerivedStateFromError(error: Error) {
    // 记录错误到监控系统
    analyticsService.logError({
      error: error.message,
      stack: error.stack,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      url: window.location.href,
    });
    
    return { hasError: true };
  }
}
```

---

## 📈 扩展性规划

### 微前端架构准备

```typescript
// 模块联邦配置预留
const federationConfig = {
  name: 'zhilink-shell',
  remotes: {
    agentsModule: 'agents@http://localhost:3001/remoteEntry.js',
    marketModule: 'market@http://localhost:3002/remoteEntry.js',
    analyticsModule: 'analytics@http://localhost:3003/remoteEntry.js',
  },
};
```

### 国际化支持

```typescript
// i18n配置
const i18nConfig = {
  locales: ['zh-CN', 'en-US', 'ja-JP'],
  defaultLocale: 'zh-CN',
  domains: [
    { domain: 'zhilink.cn', defaultLocale: 'zh-CN' },
    { domain: 'zhilink.com', defaultLocale: 'en-US' },
    { domain: 'zhilink.jp', defaultLocale: 'ja-JP' },
  ],
};
```

---

## 🎯 验收标准

### 性能指标
- **首屏加载时间**: < 1.5秒
- **页面切换响应**: < 100毫秒
- **API响应时间**: < 500毫秒
- **JavaScript包大小**: < 200KB (gzipped)

### 质量指标
- **TypeScript覆盖率**: 100%
- **单元测试覆盖率**: > 90%
- **E2E测试通过率**: 100%
- **Lighthouse分数**: > 95分

### 兼容性要求
- **浏览器支持**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **移动端支持**: iOS 14+, Android 10+
- **无障碍等级**: WCAG 2.1 AA

---

**文档版本**: 1.0.0  
**最后更新**: 2025年8月13日  
**维护者**: zhilink-v3开发团队