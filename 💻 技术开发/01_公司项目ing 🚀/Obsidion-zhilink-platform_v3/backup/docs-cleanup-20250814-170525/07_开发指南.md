# 07_开发指南.md

> **zhilink-v3 开发指南**  
> **完整的开发环境配置与最佳实践**  
> **从环境搭建到生产部署的全流程指导**

---

## 🎯 开发环境搭建

### 📋 环境要求

```bash
# 必需环境
Node.js ≥ 18.17.0
npm ≥ 9.6.7 (或 pnpm ≥ 8.6.0 推荐)
Git ≥ 2.40.0

# 推荐工具
Visual Studio Code ≥ 1.80.0
Chrome DevTools
React Developer Tools
```

### ⚡ 快速开始

```bash
# 1. 克隆项目
git clone https://github.com/launchx/zhilink-v3.git
cd zhilink-v3

# 2. 安装依赖 (推荐使用 pnpm)
pnpm install

# 3. 环境变量配置
cp .env.example .env.local

# 4. 启动开发服务器
pnpm dev

# 5. 在浏览器中打开
open http://localhost:3000
```

### 🔧 环境变量配置

```bash
# .env.local 配置示例

# 应用基础配置
NEXT_PUBLIC_APP_NAME="zhilink-v3"
NEXT_PUBLIC_APP_VERSION="3.0.0"
NEXT_PUBLIC_API_URL="https://api.zhilink.com"
NEXT_PUBLIC_WS_URL="wss://ws.zhilink.com"

# 认证配置
NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-supabase-anon-key"
SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# AI服务配置
OPENAI_API_KEY="sk-your-openai-key"
ANTHROPIC_API_KEY="your-anthropic-key"
NEXT_PUBLIC_AI_PROVIDER="openai"

# 存储配置
DATABASE_URL="postgresql://user:password@localhost:5432/zhilink"
REDIS_URL="redis://localhost:6379"
NEXT_PUBLIC_UPLOAD_URL="https://cdn.zhilink.com"

# 监控和分析
NEXT_PUBLIC_ANALYTICS_ID="your-analytics-id"
SENTRY_DSN="your-sentry-dsn"
VERCEL_ANALYTICS_ID="your-vercel-analytics-id"

# 支付配置
STRIPE_PUBLISHABLE_KEY="pk_your_stripe_key"
STRIPE_SECRET_KEY="sk_your_stripe_key"
STRIPE_WEBHOOK_SECRET="whsec_your_webhook_secret"

# 邮件服务
EMAIL_SERVER_HOST="smtp.resend.com"
EMAIL_SERVER_PORT="587"
EMAIL_SERVER_USER="your-email-user"
EMAIL_SERVER_PASSWORD="your-email-password"
EMAIL_FROM="noreply@zhilink.com"
```

---

## 📁 项目结构详解

### 🏗️ 目录架构

```
zhilink-v3/
├── 📁 .next/                    # Next.js 构建输出
├── 📁 .vscode/                  # VS Code 配置
├── 📁 docs/                     # 项目文档
│   ├── 📄 01_项目架构设计.md
│   ├── 📄 02_视觉设计系统.md
│   ├── 📄 03_页面布局方案.md
│   ├── 📄 04_交互动效设计.md
│   ├── 📄 05_组件库规范.md
│   ├── 📄 06_数据交互设计.md
│   └── 📄 07_开发指南.md
├── 📁 public/                   # 静态资源
│   ├── 📁 images/
│   ├── 📁 icons/
│   └── 📁 fonts/
├── 📁 src/                      # 源代码
│   ├── 📁 app/                  # Next.js 14 App Router
│   │   ├── 📁 (auth)/           # 认证路由组
│   │   ├── 📁 (dashboard)/      # 仪表板路由组
│   │   ├── 📁 api/              # API 路由
│   │   ├── 📄 globals.css       # 全局样式
│   │   ├── 📄 layout.tsx        # 根布局
│   │   └── 📄 page.tsx          # 首页
│   ├── 📁 components/           # 组件库
│   │   ├── 📁 ui/               # 基础UI组件
│   │   ├── 📁 business/         # 业务组件
│   │   ├── 📁 layout/           # 布局组件
│   │   └── 📁 forms/            # 表单组件
│   ├── 📁 hooks/                # 自定义Hooks
│   ├── 📁 lib/                  # 工具库
│   │   ├── 📁 api/              # API客户端
│   │   ├── 📁 auth/             # 认证逻辑
│   │   ├── 📁 database/         # 数据库操作
│   │   └── 📁 utils/            # 通用工具
│   ├── 📁 stores/               # 状态管理
│   ├── 📁 styles/               # 样式文件
│   └── 📁 types/                # TypeScript类型定义
├── 📁 tests/                    # 测试文件
├── 📄 .env.example              # 环境变量示例
├── 📄 .eslintrc.json            # ESLint配置
├── 📄 .gitignore               # Git忽略文件
├── 📄 next.config.js           # Next.js配置
├── 📄 package.json             # 项目依赖
├── 📄 tailwind.config.js       # Tailwind配置
├── 📄 tsconfig.json            # TypeScript配置
└── 📄 README.md                # 项目说明
```

### 📝 关键文件说明

#### Next.js 配置
```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    serverActions: true,
    typedRoutes: true,
  },
  
  images: {
    domains: ['cdn.zhilink.com', 'via.placeholder.com'],
    formats: ['image/webp', 'image/avif'],
  },
  
  env: {
    CUSTOM_KEY: process.env.CUSTOM_KEY,
  },
  
  async rewrites() {
    return [
      {
        source: '/api/v1/:path*',
        destination: `${process.env.API_URL}/api/v1/:path*`,
      },
    ];
  },
  
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
        ],
      },
    ];
  },
  
  webpack: (config, { buildId, dev, isServer, defaultLoaders, nextRuntime, webpack }) => {
    // 自定义 webpack 配置
    if (!isServer) {
      config.resolve.fallback = {
        ...config.resolve.fallback,
        fs: false,
        net: false,
        tls: false,
      };
    }
    
    return config;
  },
};

module.exports = nextConfig;
```

#### TypeScript 配置
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "dom.iterable", "es6"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@/components/*": ["./src/components/*"],
      "@/hooks/*": ["./src/hooks/*"],
      "@/lib/*": ["./src/lib/*"],
      "@/styles/*": ["./src/styles/*"],
      "@/types/*": ["./src/types/*"],
      "@/stores/*": ["./src/stores/*"],
      "@/utils/*": ["./src/lib/utils/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": ["node_modules"]
}
```

---

## 💻 开发工作流

### 🔄 Git 工作流

```bash
# 1. 功能开发流程
git checkout -b feature/user-authentication
git add .
git commit -m "feat(auth): implement user authentication system"
git push origin feature/user-authentication

# 2. 提交信息规范 (Conventional Commits)
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 样式修改
refactor: 代码重构
test: 测试相关
chore: 构建过程或辅助工具的变动

# 3. 分支管理
main        # 主分支，用于生产部署
develop     # 开发分支，用于功能集成
feature/*   # 功能分支
hotfix/*    # 紧急修复分支
release/*   # 发布分支
```

### ⚡ 开发命令详解

```bash
# 开发相关命令
pnpm dev              # 启动开发服务器 (localhost:3000)
pnpm dev:turbo        # 使用 Turbopack 启动 (更快)
pnpm build            # 生产环境构建
pnpm start            # 启动生产服务器
pnpm preview          # 预览生产构建

# 代码质量检查
pnpm lint             # ESLint 检查
pnpm lint:fix         # 自动修复 ESLint 问题
pnpm typecheck        # TypeScript 类型检查
pnpm format:check     # Prettier 格式检查
pnpm format:write     # Prettier 格式化代码

# 测试相关命令
pnpm test             # 运行单元测试
pnpm test:watch       # 监听模式运行测试
pnpm test:coverage    # 生成测试覆盖率报告
pnpm test:e2e         # 运行端到端测试

# 数据库操作
pnpm db:generate      # 生成 Prisma 客户端
pnpm db:push          # 推送 schema 到数据库
pnpm db:migrate       # 运行数据库迁移
pnpm db:studio        # 打开 Prisma Studio
pnpm db:seed          # 填充种子数据

# 组件开发
pnpm storybook        # 启动 Storybook
pnpm build-storybook  # 构建 Storybook

# 分析和调试
pnpm analyze          # 分析构建包大小
pnpm bundle-analyzer  # 可视化包分析
pnpm lighthouse       # 运行 Lighthouse 分析
```

### 🧪 测试策略

```typescript
// 测试配置 - jest.config.js
const config = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testPathIgnorePatterns: ['<rootDir>/.next/', '<rootDir>/node_modules/'],
  transform: {
    '^.+\\.(js|jsx|ts|tsx)$': ['babel-jest', { presets: ['next/babel'] }],
  },
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};

module.exports = config;
```

### 📏 代码规范

#### ESLint 配置
```json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "warn",
    "react-hooks/exhaustive-deps": "warn",
    "prefer-const": "error",
    "no-var": "error"
  },
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": 2020,
    "sourceType": "module",
    "ecmaFeatures": {
      "jsx": true
    }
  }
}
```

#### Prettier 配置
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "bracketSpacing": true,
  "bracketSameLine": false,
  "arrowParens": "avoid"
}
```

---

## 🧩 组件开发指南

### 📝 组件编写规范

```typescript
// 组件模板示例
// src/components/ui/example-component.tsx

import React from 'react';
import { cn } from '@/lib/utils';
import { cva, type VariantProps } from 'class-variance-authority';

// 1. 样式变体定义
const exampleVariants = cva(
  'base-styles-here',
  {
    variants: {
      variant: {
        default: 'default-styles',
        secondary: 'secondary-styles',
      },
      size: {
        sm: 'small-styles',
        md: 'medium-styles',
        lg: 'large-styles',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'md',
    },
  }
);

// 2. 组件Props接口
interface ExampleComponentProps 
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof exampleVariants> {
  children: React.ReactNode;
  disabled?: boolean;
  loading?: boolean;
}

// 3. 组件实现
const ExampleComponent = React.forwardRef<HTMLDivElement, ExampleComponentProps>(
  ({ className, variant, size, children, disabled, loading, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(exampleVariants({ variant, size }), className)}
        aria-disabled={disabled}
        {...props}
      >
        {loading ? <LoadingSpinner /> : children}
      </div>
    );
  }
);

ExampleComponent.displayName = 'ExampleComponent';

export { ExampleComponent, exampleVariants };
export type { ExampleComponentProps };
```

### 🎨 样式编写规范

```css
/* Tailwind CSS 自定义样式 */
/* src/styles/components.css */

@layer components {
  /* 基础组件样式 */
  .btn-base {
    @apply inline-flex items-center justify-center;
    @apply rounded-lg font-medium transition-colors;
    @apply focus-visible:outline-none focus-visible:ring-2;
    @apply disabled:pointer-events-none disabled:opacity-50;
  }
  
  /* Cloudsway 设计系统样式 */
  .card-cloudsway {
    @apply bg-cloudsway-glass-bg backdrop-blur-xl;
    @apply border border-cloudsway-glass-border;
    @apply rounded-xl shadow-lg;
  }
  
  /* 6角色颜色样式 */
  .agent-alex { @apply text-[#3b82f6] bg-[#3b82f6]/10; }
  .agent-sarah { @apply text-[#8b5cf6] bg-[#8b5cf6]/10; }
  .agent-mike { @apply text-[#10b981] bg-[#10b981]/10; }
  .agent-emma { @apply text-[#f59e0b] bg-[#f59e0b]/10; }
  .agent-david { @apply text-[#6366f1] bg-[#6366f1]/10; }
  .agent-catherine { @apply text-[#ec4899] bg-[#ec4899]/10; }
}

@layer utilities {
  /* 实用工具类 */
  .text-gradient-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
}
```

### 🔧 Hooks 开发规范

```typescript
// 自定义Hook示例
// src/hooks/use-example.ts

import { useState, useEffect, useCallback } from 'react';

interface UseExampleOptions {
  initialValue?: string;
  debounceMs?: number;
}

interface UseExampleReturn {
  value: string;
  setValue: (value: string) => void;
  debouncedValue: string;
  isLoading: boolean;
  error: Error | null;
}

export function useExample(options: UseExampleOptions = {}): UseExampleReturn {
  const { initialValue = '', debounceMs = 300 } = options;
  
  const [value, setValue] = useState(initialValue);
  const [debouncedValue, setDebouncedValue] = useState(initialValue);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<Error | null>(null);
  
  // 防抖处理
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedValue(value);
    }, debounceMs);
    
    return () => clearTimeout(timer);
  }, [value, debounceMs]);
  
  // 业务逻辑处理
  const handleSetValue = useCallback((newValue: string) => {
    try {
      setIsLoading(true);
      setError(null);
      setValue(newValue);
      
      // 执行副作用
      // ...
      
    } catch (err) {
      setError(err as Error);
    } finally {
      setIsLoading(false);
    }
  }, []);
  
  return {
    value,
    setValue: handleSetValue,
    debouncedValue,
    isLoading,
    error,
  };
}
```

---

## 🗄️ 数据库开发

### 📊 Prisma Schema 设计

```prisma
// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatar    String?
  role      UserRole @default(BUYER)
  
  // 公司信息
  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?
  
  // 偏好设置
  preferences Json?
  
  // 订阅信息
  subscription UserSubscription?
  
  // 关联关系
  sessions     AnalysisSession[]
  orders       Order[]
  reviews      Review[]
  favorites    UserFavorite[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// 产品表
model Product {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String
  type        ProductType
  status      ProductStatus @default(DRAFT)
  
  // 供应商信息
  vendor   Vendor @relation(fields: [vendorId], references: [id])
  vendorId String
  
  // 产品信息
  category String
  tags     String[]
  industry Industry[]
  
  // 媒体资源
  images      String[]
  videos      String[]
  documents   Json?
  
  // 定价信息
  pricing Json
  
  // 技术指标
  metrics Json?
  
  // 评价统计
  rating      Float   @default(0)
  ratingCount Int     @default(0)
  
  // 关联关系
  reviews     Review[]
  favorites   UserFavorite[]
  orderItems  OrderItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  
  @@map("products")
}

// 分析会话表
model AnalysisSession {
  id     String            @id @default(cuid())
  title  String
  status AnalysisStatus    @default(INITIALIZING)
  
  // 用户信息
  user   User   @relation(fields: [userId], references: [id])
  userId String
  
  // 会话内容
  input     Json  // 用户输入
  analysis  Json? // 6角色分析结果
  synthesis Json? // 综合结果
  
  // 消息记录
  messages ChatMessage[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  
  @@map("analysis_sessions")
}

// 枚举定义
enum UserRole {
  BUYER
  VENDOR
  DISTRIBUTOR
}

enum ProductType {
  WORKFORCE
  EXPERT_MODULE
  MARKET_REPORT
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum Industry {
  LEGAL
  MEDICAL
  ECOMMERCE
}

enum AnalysisStatus {
  INITIALIZING
  ANALYZING
  COMPLETED
  FAILED
}
```

### 🔧 数据库操作示例

```typescript
// src/lib/database/products.ts
import { prisma } from '@/lib/database/client';
import { Product, ProductFilters } from '@/types';

export class ProductRepository {
  // 获取产品列表
  async findMany(filters: ProductFilters, page = 1, limit = 20) {
    const skip = (page - 1) * limit;
    
    const where = {
      status: 'PUBLISHED',
      ...(filters.type && { type: { in: filters.type } }),
      ...(filters.category && { category: { in: filters.category } }),
      ...(filters.industry && { industry: { hasMany: filters.industry } }),
      ...(filters.search && {
        OR: [
          { name: { contains: filters.search, mode: 'insensitive' } },
          { description: { contains: filters.search, mode: 'insensitive' } },
          { tags: { has: filters.search } },
        ],
      }),
    };
    
    const [products, total] = await Promise.all([
      prisma.product.findMany({
        where,
        include: {
          vendor: true,
          _count: {
            select: {
              reviews: true,
              favorites: true,
            },
          },
        },
        skip,
        take: limit,
        orderBy: this.buildOrderBy(filters.sort, filters.order),
      }),
      prisma.product.count({ where }),
    ]);
    
    return {
      items: products,
      pagination: {
        page,
        pageSize: limit,
        total,
        totalPages: Math.ceil(total / limit),
        hasNext: page * limit < total,
        hasPrevious: page > 1,
      },
    };
  }
  
  // 获取产品详情
  async findById(id: string) {
    return prisma.product.findUnique({
      where: { id },
      include: {
        vendor: true,
        reviews: {
          include: {
            user: {
              select: { name: true, avatar: true },
            },
          },
          orderBy: { createdAt: 'desc' },
          take: 10,
        },
        _count: {
          select: {
            reviews: true,
            favorites: true,
          },
        },
      },
    });
  }
  
  // 搜索产品
  async search(query: string, filters: ProductFilters) {
    return prisma.product.findMany({
      where: {
        status: 'PUBLISHED',
        OR: [
          { name: { contains: query, mode: 'insensitive' } },
          { description: { contains: query, mode: 'insensitive' } },
          { tags: { has: query } },
        ],
        ...(filters.type && { type: { in: filters.type } }),
        ...(filters.category && { category: { in: filters.category } }),
      },
      include: {
        vendor: true,
        _count: {
          select: { reviews: true, favorites: true },
        },
      },
      take: 50,
    });
  }
  
  private buildOrderBy(sort?: string, order?: 'asc' | 'desc') {
    const direction = order || 'desc';
    
    switch (sort) {
      case 'name':
        return { name: direction };
      case 'rating':
        return { rating: direction };
      case 'popularity':
        return { ratingCount: direction };
      case 'newest':
        return { createdAt: direction };
      default:
        return { createdAt: 'desc' };
    }
  }
}

export const productRepository = new ProductRepository();
```

---

## 🚀 部署指南

### 🌐 Vercel 部署 (推荐)

```bash
# 1. 安装 Vercel CLI
npm i -g vercel

# 2. 登录 Vercel
vercel login

# 3. 项目初始化
vercel

# 4. 环境变量配置
vercel env add NEXT_PUBLIC_API_URL
vercel env add DATABASE_URL
vercel env add OPENAI_API_KEY

# 5. 部署到生产环境
vercel --prod
```

### 🐳 Docker 部署

```dockerfile
# Dockerfile
FROM node:18-alpine AS base

# 安装依赖
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

COPY package.json pnpm-lock.yaml* ./
RUN corepack enable pnpm && pnpm i --frozen-lockfile

# 构建应用
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

ENV NEXT_TELEMETRY_DISABLED 1
RUN corepack enable pnpm && pnpm build

# 生产镜像
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/zhilink
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: zhilink
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### ☁️ AWS 部署

```bash
# 使用 AWS CDK 部署
npm install -g aws-cdk

# 初始化 CDK 项目
cdk init app --language typescript

# 部署到 AWS
cdk deploy
```

---

## 🔍 调试与监控

### 🐛 调试工具配置

```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Next.js: debug server-side",
      "type": "node",
      "request": "attach",
      "port": 9229,
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "name": "Next.js: debug client-side",
      "type": "chrome",
      "request": "launch",
      "url": "http://localhost:3000"
    },
    {
      "name": "Next.js: debug full stack",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/node_modules/.bin/next",
      "args": ["dev"],
      "console": "integratedTerminal",
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
```

### 📊 性能监控

```typescript
// src/lib/monitoring/performance.ts
import { NextWebVitalsMetric } from 'next/app';

export function reportWebVitals(metric: NextWebVitalsMetric) {
  const { id, name, label, value } = metric;
  
  // 发送到分析服务
  if (process.env.NODE_ENV === 'production') {
    // Google Analytics
    window.gtag?.('event', name, {
      event_category: label === 'web-vital' ? 'Web Vitals' : 'Next.js custom metric',
      value: Math.round(name === 'CLS' ? value * 1000 : value),
      event_label: id,
      non_interaction: true,
    });
    
    // Vercel Analytics
    window.va?.track(name, { value, label });
    
    // 自定义监控
    fetch('/api/analytics/web-vitals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ metric }),
    });
  }
  
  // 开发环境日志
  if (process.env.NODE_ENV === 'development') {
    console.log('Web Vital:', { name, value, label });
  }
}
```

### 🚨 错误监控

```typescript
// src/lib/monitoring/error-boundary.tsx
import React from 'react';
import * as Sentry from '@sentry/nextjs';

interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends React.Component<
  React.PropsWithChildren<{}>,
  ErrorBoundaryState
> {
  constructor(props: React.PropsWithChildren<{}>) {
    super(props);
    this.state = { hasError: false };
  }
  
  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }
  
  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    // 发送错误到 Sentry
    Sentry.captureException(error, {
      contexts: {
        react: {
          componentStack: errorInfo.componentStack,
        },
      },
    });
    
    // 自定义错误日志
    console.error('Error caught by boundary:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen flex items-center justify-center">
          <div className="text-center">
            <h2 className="text-2xl font-bold mb-4">出错了</h2>
            <p className="text-gray-600 mb-4">
              应用遇到了一个错误，我们已经记录了这个问题。
            </p>
            <button
              onClick={() => this.setState({ hasError: false })}
              className="btn-primary"
            >
              重试
            </button>
          </div>
        </div>
      );
    }
    
    return this.props.children;
  }
}
```

---

## 📋 开发检查清单

### 🏗️ 项目初始化
- [ ] 环境变量配置完成
- [ ] 数据库连接正常
- [ ] 依赖安装无错误
- [ ] 开发服务器启动成功
- [ ] Git 仓库初始化

### 💻 开发环境配置
- [ ] VS Code 插件安装完成
- [ ] ESLint 配置正确
- [ ] Prettier 格式化正常
- [ ] TypeScript 编译无错误
- [ ] 调试配置可用

### 🧪 代码质量检查
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] E2E 测试关键路径
- [ ] 性能测试通过
- [ ] 安全检查通过
- [ ] 代码审查完成

### 🚀 部署准备
- [ ] 生产环境变量配置
- [ ] 构建流程测试
- [ ] Docker 镜像构建
- [ ] 监控和日志配置
- [ ] 错误追踪设置

### 📊 性能优化
- [ ] Core Web Vitals 达标
- [ ] 包大小优化
- [ ] 图片优化
- [ ] 缓存策略实现
- [ ] CDN 配置

---

## 🆘 常见问题解决

### ❌ 常见错误

#### 1. 模块解析错误
```bash
Error: Cannot resolve module '@/components/ui/button'

# 解决方案：
# 检查 tsconfig.json 中的 paths 配置
# 确保 baseUrl 设置正确
```

#### 2. 样式不生效
```bash
Tailwind CSS 样式没有应用

# 解决方案：
# 检查 tailwind.config.js 的 content 配置
# 确保样式文件正确导入
# 清除 .next 缓存重新构建
```

#### 3. API 连接失败
```bash
Network Error: Cannot connect to API

# 解决方案：
# 检查 .env.local 中的 API_URL 配置
# 确保 API 服务正在运行
# 检查 CORS 配置
```

### 🔧 性能调优

```typescript
// 组件性能优化示例
import { memo, useMemo, useCallback } from 'react';

const OptimizedComponent = memo(({ items, onItemClick }) => {
  // 使用 useMemo 缓存计算结果
  const processedItems = useMemo(() => {
    return items.map(item => ({
      ...item,
      processed: true,
    }));
  }, [items]);
  
  // 使用 useCallback 缓存函数引用
  const handleClick = useCallback((id: string) => {
    onItemClick(id);
  }, [onItemClick]);
  
  return (
    <div>
      {processedItems.map(item => (
        <div key={item.id} onClick={() => handleClick(item.id)}>
          {item.name}
        </div>
      ))}
    </div>
  );
});
```

### 🔐 安全最佳实践

```typescript
// 输入验证和清理
import DOMPurify from 'dompurify';
import { z } from 'zod';

// 使用 Zod 进行输入验证
const userInputSchema = z.object({
  name: z.string().min(1).max(100),
  email: z.string().email(),
  content: z.string().max(1000),
});

// 清理 HTML 内容
const sanitizeHtml = (html: string) => {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em'],
    ALLOWED_ATTR: [],
  });
};

// API 路由安全示例
export async function POST(request: Request) {
  try {
    const body = await request.json();
    
    // 验证输入
    const validatedData = userInputSchema.parse(body);
    
    // 清理内容
    const cleanContent = sanitizeHtml(validatedData.content);
    
    // 处理业务逻辑
    // ...
    
  } catch (error) {
    if (error instanceof z.ZodError) {
      return Response.json({ error: 'Invalid input' }, { status: 400 });
    }
    
    return Response.json({ error: 'Internal error' }, { status: 500 });
  }
}
```

---

**文档版本**: v3.0.0  
**最后更新**: 2025年8月13日  
**负责团队**: LaunchX前端开发团队