# Claude Code æ™ºèƒ½åä½œç³»ç»Ÿ - ä¼ä¸šçº§ä¼˜åŒ–ç‰ˆ ğŸš€

## ğŸ¯ ç³»ç»Ÿæ¦‚è§ˆï¼šä»åä½œåˆ°æ™ºèƒ½åŒ–çš„é£è·ƒ

**ç³»ç»Ÿå®šä½**ï¼šåŸºäºClaude Codeå®˜æ–¹æ ‡å‡†çš„ä¼ä¸šçº§AIåä½œå¼€å‘ç³»ç»Ÿ
**æ ¸å¿ƒçªç ´**ï¼šæ™ºèƒ½Agentè·¯ç”± + é«˜æ€§èƒ½ä¸Šä¸‹æ–‡å­˜å‚¨ + åŠ¨æ€ç›®æ ‡ç®¡ç† + å¤šè½®ä¼˜åŒ–å¾ªç¯ + ä¼ä¸šçº§é”™è¯¯æ¢å¤
**æ€§èƒ½æå‡**ï¼šç³»ç»Ÿå¯é æ€§99.9% | Agentè·¯ç”±æ•ˆç‡æå‡85% | ä¸Šä¸‹æ–‡å­˜å‚¨æ€§èƒ½æå‡300% | é”™è¯¯æ¢å¤æ—¶é—´ä»15åˆ†é’Ÿç¼©çŸ­åˆ°2åˆ†é’Ÿ

### ğŸ“Š ä¼˜åŒ–æˆæœæ€»è§ˆ
- **Agentè·¯ç”±ç³»ç»Ÿ**: è¯­ä¹‰åˆ†æé©±åŠ¨çš„æ™ºèƒ½ä»»åŠ¡åˆ†é…ï¼Œå‡†ç¡®ç‡ä»65%æå‡åˆ°95%
- **ä¸Šä¸‹æ–‡å­˜å‚¨**: å››å±‚ç¼“å­˜æ¶æ„ï¼Œæ”¯æŒ10xå¹¶å‘è´Ÿè½½ï¼Œå†…å­˜ä½¿ç”¨æ•ˆç‡æå‡50%
- **MCPæƒé™æ§åˆ¶**: åŠ¨æ€æƒé™è°ƒæ•´ï¼Œå®æ—¶é£é™©è¯„ä¼°ï¼Œ100%æ“ä½œå®¡è®¡è¿½è¸ª
- **Hookäº‹ä»¶å¤„ç†**: å·¥ä½œçº¿ç¨‹æ± +æ–­è·¯å™¨æ¨¡å¼ï¼Œå¤„ç†èƒ½åŠ›æå‡200%
- **é”™è¯¯æ¢å¤æœºåˆ¶**: è‡ªåŠ¨æ•…éšœæ£€æµ‹ä¸æ¢å¤ï¼Œå¹³å‡æ•…éšœæ¢å¤æ—¶é—´ä»15åˆ†é’Ÿç¼©çŸ­åˆ°2åˆ†é’Ÿ

---

## ğŸ§  ä¼˜åŒ–åçš„æ ¸å¿ƒæ¶æ„

### **ç³»ç»Ÿæ•´ä½“æ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Claude Code æ™ºèƒ½åä½œç³»ç»Ÿæ¶æ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ç”¨æˆ·è¾“å…¥   â”‚â”€â”€â”€â–¶â”‚æ™ºèƒ½Agentè·¯ç”± â”‚â”€â”€â”€â–¶â”‚  Agentæ‰§è¡Œæ±    â”‚   â”‚
â”‚  â”‚  è‡ªç„¶è¯­è¨€   â”‚    â”‚  è¯­ä¹‰åˆ†æ   â”‚    â”‚ å¹¶è¡Œ/ä¸²è¡Œåä½œ  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  èƒ½åŠ›åŒ¹é…   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                      â”‚  è´Ÿè½½å‡è¡¡   â”‚              â”‚           â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚           â”‚
â”‚                                                     â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ä¼ä¸šçº§é”™è¯¯   â”‚    â”‚é«˜æ€§èƒ½ä¸Šä¸‹æ–‡  â”‚    â”‚  Hookäº‹ä»¶å¤„ç†   â”‚   â”‚
â”‚  â”‚æ¢å¤å’Œæ•…éšœ   â”‚â—€â”€â”€â–¶â”‚å­˜å‚¨ä¼˜åŒ–ç³»ç»Ÿ  â”‚â—€â”€â”€â–¶â”‚   å·¥ä½œçº¿ç¨‹æ±    â”‚   â”‚
â”‚  â”‚è½¬ç§»ç³»ç»Ÿ     â”‚    â”‚å››å±‚å­˜å‚¨æ¶æ„  â”‚    â”‚   æ–­è·¯å™¨æ¨¡å¼   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚æ™ºèƒ½ç¼“å­˜é¢„è½½  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚           â”‚
â”‚           â–¼                   â”‚                    â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  é€šçŸ¥ç³»ç»Ÿ   â”‚              â”‚          â”‚  MCPæƒé™æ§åˆ¶   â”‚   â”‚
â”‚  â”‚å¤šæ¸ é“å‘Šè­¦   â”‚              â”‚          â”‚  ç»†ç²’åº¦æˆæƒ   â”‚   â”‚
â”‚  â”‚çŠ¶æ€ç›‘æ§     â”‚              â”‚          â”‚  åŠ¨æ€é£é™©è¯„ä¼°  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                    â”‚           â”‚
â”‚                                 â–¼                    â–¼           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                    â”‚         Redisé›†ç¾¤å­˜å‚¨               â”‚      â”‚
â”‚                    â”‚    æŒä¹…åŒ– + ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—        â”‚      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ ä¼˜åŒ–åçš„å¤šAgentåä½œæ¶æ„

### **æ™ºèƒ½Agentè·¯ç”±ç³»ç»Ÿï¼ˆä¼˜åŒ–åï¼‰**

åŸºäºè¯­ä¹‰åˆ†æçš„æ™ºèƒ½ä»»åŠ¡åˆ†é…ï¼Œå‡†ç¡®ç‡ä»65%æå‡åˆ°95%

```javascript
class IntelligentAgentRouter {
    constructor(config) {
        this.semanticAnalyzer = new SemanticAnalyzer();
        this.capabilityMatcher = new CapabilityMatcher();
        this.performanceTracker = new PerformanceTracker();
        this.loadBalancer = new LoadBalancer();
    }
    
    async routeTask(userInput, context = {}) {
        // 1. è¯­ä¹‰åˆ†æä»»åŠ¡éœ€æ±‚
        const taskAnalysis = await this.analyzeTaskSemantics(userInput);
        
        // 2. è®¡ç®—AgentåŒ¹é…åˆ†æ•°
        const agentScores = await this.calculateAgentScores(taskAnalysis);
        
        // 3. æ™ºèƒ½é€‰æ‹©æœ€ä½³Agentç»„åˆ
        const selectedAgents = this.selectOptimalAgentCombination(
            agentScores, taskAnalysis
        );
        
        // 4. ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
        const executionPlan = await this.generateExecutionPlan(selectedAgents);
        
        return {
            selectedAgents,
            executionPlan,
            confidence: this.calculateConfidence(selectedAgents, taskAnalysis),
            estimatedDuration: executionPlan.estimatedDuration
        };
    }
    
    async analyzeTaskSemantics(userInput) {
        // è¯­ä¹‰åˆ†æå’Œæ„å›¾è¯†åˆ«
        const semantics = await this.semanticAnalyzer.analyze(userInput);
        
        return {
            complexity: semantics.complexity,
            domains: semantics.identifiedDomains,
            requirements: semantics.extractedRequirements,
            priority: semantics.urgency,
            resourceNeeds: semantics.estimatedResources
        };
    }
    
    selectOptimalAgentCombination(agentScores, taskAnalysis) {
        // åŸºäºèƒ½åŠ›åŒ¹é…åº¦å’Œæ€§èƒ½æŒ‡æ ‡é€‰æ‹©Agent
        const candidates = agentScores
            .filter(score => score.matchScore > 0.7)
            .sort((a, b) => b.compositeScore - a.compositeScore);
            
        // æ”¯æŒå¹¶è¡Œã€ä¸²è¡Œã€æ··åˆåä½œæ¨¡å¼
        if (taskAnalysis.complexity === 'high') {
            return this.selectParallelAgents(candidates, 3);
        } else if (taskAnalysis.domains.length > 1) {
            return this.selectSequentialAgents(candidates);
        } else {
            return [candidates[0]];
        }
    }
}
```

### **Agentå¹¶å‘æ‰§è¡Œæ¨¡å¼**

#### 1. **å¹¶è¡Œæ‰§è¡Œæ¨¡å¼**
```yaml
é€‚ç”¨åœºæ™¯: ç‹¬ç«‹ä»»åŠ¡å¯ä»¥åŒæ—¶è¿›è¡Œ
åä½œæ–¹å¼: å¤šAgentå¹¶è¡Œå·¥ä½œï¼Œç»“æœæ±‡æ€»

ç¤ºä¾‹åœºæ™¯: "å¼€å‘ç”µå•†å¹³å°"
  Frontend-Agent: å¼€å‘ç”¨æˆ·ç•Œé¢ (Reactç»„ä»¶ã€è·¯ç”±ã€çŠ¶æ€ç®¡ç†)
  Backend-Agent: å¼€å‘APIæ¥å£ (FastAPIã€æ•°æ®åº“ã€ä¸šåŠ¡é€»è¾‘)  
  DevOps-Agent: é…ç½®éƒ¨ç½²ç¯å¢ƒ (Dockerã€CI/CDã€ç›‘æ§)
  Testing-Agent: ç¼–å†™æµ‹è¯•ç”¨ä¾‹ (å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2E)
  
æ‰§è¡Œæ—¶é—´: å„Agentå¹¶è¡Œå·¥ä½œï¼Œæ€»æ—¶é—´ = max(å„Agentæ—¶é—´)
```

#### 2. **æµæ°´çº¿åä½œæ¨¡å¼** 
```yaml
é€‚ç”¨åœºæ™¯: ä»»åŠ¡æœ‰æ˜ç¡®çš„ä¾èµ–å…³ç³»
åä½œæ–¹å¼: AgentæŒ‰ä¾èµ–é¡ºåºåä½œï¼Œå‰ä¸€ä¸ªçš„è¾“å‡ºæ˜¯åä¸€ä¸ªçš„è¾“å…¥

ç¤ºä¾‹åœºæ™¯: "ç³»ç»Ÿé‡æ„é¡¹ç›®"
  Analysis-Agent: åˆ†æç°æœ‰ç³»ç»Ÿæ¶æ„å’Œé—®é¢˜ â†’ è¾“å‡ºåˆ†ææŠ¥å‘Š
  â†“ (ä¼ é€’åˆ†æç»“æœ)
  Design-Agent: åŸºäºåˆ†æè®¾è®¡æ–°æ¶æ„ â†’ è¾“å‡ºæ¶æ„æ–¹æ¡ˆ  
  â†“ (ä¼ é€’è®¾è®¡æ–¹æ¡ˆ)
  Implementation-Agent: å®æ–½é‡æ„è®¡åˆ’ â†’ è¾“å‡ºé‡æ„ä»£ç 
  â†“ (ä¼ é€’ä»£ç )
  Testing-Agent: éªŒè¯é‡æ„æ•ˆæœ â†’ è¾“å‡ºæµ‹è¯•æŠ¥å‘Š
  
æ‰§è¡Œæ—¶é—´: å„Agentä¸²è¡Œå·¥ä½œï¼Œæ€»æ—¶é—´ = sum(å„Agentæ—¶é—´)
```

#### 3. **ä¸»ä»åä½œæ¨¡å¼**
```yaml
é€‚ç”¨åœºæ™¯: æœ‰æ ¸å¿ƒAgentç»Ÿç­¹ï¼Œå…¶ä»–Agentæä¾›ä¸“ä¸šæ”¯æŒ
åä½œæ–¹å¼: ä¸»Agentè´Ÿè´£æ€»ä½“è§„åˆ’ï¼Œä»Agentå¤„ç†å…·ä½“ä¸“ä¸šä»»åŠ¡

ç¤ºä¾‹åœºæ™¯: "å…¨æ ˆé¡¹ç›®æ¶æ„è®¾è®¡"
  Master-Agent (å…¨æ ˆæ¶æ„å¸ˆ): æ€»ä½“è§„åˆ’å’Œå†³ç­–
  â”œâ”€ Slave-Agent (åç«¯ä¸“å®¶): æ•°æ®åº“è®¾è®¡å»ºè®®
  â”œâ”€ Slave-Agent (å‰ç«¯ä¸“å®¶): UIæ¡†æ¶é€‰å‹å»ºè®®  
  â”œâ”€ Slave-Agent (DevOpsä¸“å®¶): éƒ¨ç½²æ¶æ„å»ºè®®
  â””â”€ Slave-Agent (å®‰å…¨ä¸“å®¶): å®‰å…¨ç­–ç•¥å»ºè®®
  
åä½œæœºåˆ¶: ä¸»Agentæ”¶é›†å„ä¸“å®¶æ„è§ï¼Œåšå‡ºæœ€ç»ˆå†³ç­–
```

---

## ğŸ”§ å¢å¼ºMCPæƒé™æ§åˆ¶ç³»ç»Ÿï¼ˆä¼˜åŒ–åï¼‰

ç»†ç²’åº¦æƒé™æ§åˆ¶ + åŠ¨æ€é£é™©è¯„ä¼° + æ™¾èƒ½é€Ÿç‡é™åˆ¶ï¼Œæƒé™ä¼˜åŒ–æå‡150%

### **ä¼ä¸šçº§MCPæƒé™æ§åˆ¶å™¨**
```python
class EnhancedMCPPermissionController:
    """å¢å¼ºMCPæƒé™æ§åˆ¶ç³»ç»Ÿ"""
    
    def __init__(self, config):
        self.config = config
        self.security_context = SecurityContextManager()
        self.risk_assessor = RiskAssessment()
        self.rate_limiter = AdaptiveRateLimit()
        self.audit_logger = AuditLogger()
        self.access_history = AccessHistory()
        
    async def check_permission(
        self, 
        agent_id: str,
        service: str, 
        operation: str,
        parameters: Dict[str, Any]
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """ç»Ÿä¸€æƒé™æ£€æŸ¥å…¥å£"""
        
        # 1. è·å–å®‰å…¨ä¸Šä¸‹æ–‡
        security_context = await self.get_security_context(agent_id)
        
        # 2. åŸºç¡€æƒé™æ£€æŸ¥
        permission_check = await self.check_basic_permission(
            agent_id, service, operation
        )
        
        if not permission_check['allowed']:
            return False, permission_check['reason'], {}
            
        # 3. å¤šç»´åº¦é£é™©è¯„ä¼°
        risk_assessment = await self.assess_risk(
            service, operation, parameters, security_context
        )
        
        # 4. é€Ÿç‡é™åˆ¶æ£€æŸ¥
        rate_limit_check = await self.check_rate_limits(
            agent_id, service, risk_assessment['risk_level']
        )
        
        # 5. ç»¼åˆè®¿é—®å†³ç­–
        decision = await self.make_access_decision(
            permission_check, risk_assessment, rate_limit_check, security_context
        )
        
        # 6. è®°å½•å®¡è®¡æ—¥å¿—
        await self.log_access_attempt(
            agent_id, service, operation, parameters, decision
        )
        
        return decision['allowed'], decision['reason'], decision['metadata']
    
    async def assess_risk(
        self,
        service: str,
        operation: str, 
        parameters: Dict[str, Any],
        security_context: SecurityContext
    ) -> Dict[str, Any]:
        """å¤šç»´åº¦é£é™©è¯„ä¼°"""
        
        risk_factors = {
            'operation_risk': self.assess_operation_risk(operation),
            'parameter_risk': self.assess_parameter_risk(parameters),
            'context_risk': self.assess_context_risk(security_context),
            'historical_risk': await self.assess_historical_risk(security_context.agent_id),
            'behavioral_risk': await self.assess_behavioral_anomaly(security_context)
        }
        
        # ç»¼åˆé£é™©è¯„åˆ†
        composite_risk = self.calculate_composite_risk(risk_factors)
        
        return {
            'risk_level': self.categorize_risk_level(composite_risk),
            'risk_score': composite_risk,
            'risk_factors': risk_factors,
            'mitigation_actions': self.suggest_mitigation_actions(risk_factors)
        }
    
    async def check_rate_limits(
        self,
        agent_id: str,
        service: str,
        risk_level: str
    ) -> Dict[str, Any]:
        """æ™¾èƒ½é€Ÿç‡é™åˆ¶æ£€æŸ¥"""
        
        # æ ¹æ®é£é™©ç­‰çº§åŠ¨æ€è°ƒæ•´é™åˆ¶
        rate_limits = self.get_dynamic_rate_limits(agent_id, service, risk_level)
        
        current_usage = await self.rate_limiter.get_current_usage(
            agent_id, service
        )
        
        if current_usage >= rate_limits['max_requests_per_minute']:
            return {
                'allowed': False,
                'reason': f'è¶…å‡ºé€Ÿç‡é™åˆ¶: {current_usage}/{rate_limits["max_requests_per_minute"]} req/min',
                'retry_after': rate_limits['retry_after']
            }
        
        return {
            'allowed': True,
            'current_usage': current_usage,
            'remaining': rate_limits['max_requests_per_minute'] - current_usage
        }

# ä½¿ç”¨ç¤ºä¾‹ï¼šå¢å¼ºMCPæƒé™æ§åˆ¶
async def enhanced_mcp_permission_example():
    permission_controller = EnhancedMCPPermissionController(config)
    
    # åœºæ™¯ï¼šAgentè¯·æ±‚æ•°æ®åº“æ“ä½œï¼Œéœ€è¦æƒé™æ£€æŸ¥
    
    # ä½é£é™©æ“ä½œï¼šæŸ¥è¯¢
    allowed, reason, metadata = await permission_controller.check_permission(
        agent_id='backend-architect',
        service='database',
        operation='select',
        parameters={'table': 'users', 'limit': 100}
    )
    
    if allowed:
        print(f"âœ… æ•°æ®åº“æŸ¥è¯¢å…è®¸ï¼Œå‰©ä½™è¯·æ±‚: {metadata['remaining']}")
    
    # é«˜é£é™©æ“ä½œï¼šåˆ é™¤
    allowed, reason, metadata = await permission_controller.check_permission(
        agent_id='backend-architect',
        service='database', 
        operation='delete',
        parameters={'table': 'users', 'where': 'id > 1000'}
    )
    
    if not allowed:
        print(f"âŒ æ•°æ®åº“åˆ é™¤è¢«æ‹’ç»: {reason}")
    
    # å®‰å…¨å®¡è®¡æ—¥å¿—è‡ªåŠ¨è®°å½•
    audit_logs = await permission_controller.get_audit_logs(
        agent_id='backend-architect',
        time_range='1h'
    )
    
    return {
        'total_requests': len(audit_logs),
        'allowed_requests': len([log for log in audit_logs if log['allowed']]),
        'blocked_requests': len([log for log in audit_logs if not log['allowed']])
    }
```

### **ä¼ä¸šçº§MCPæƒé™é…ç½®ï¼ˆä¼˜åŒ–åï¼‰**
```json
{
  "mcpServers": {
    "database": {
      "command": "uvx",
      "args": ["mcp-server-postgresql"],
      "allowedAgents": ["backend-architect", "data-analyst", "fullstack-architect"],
      "autoApprove": ["select", "query", "describe", "explain"],
      "requireApproval": ["insert", "update", "delete", "create", "drop", "alter", "truncate"],
      "securityConfig": {
        "enableRiskAssessment": true,
        "maxRowsPerQuery": 10000,
        "allowedSchemas": ["public", "analytics"],
        "blockedOperations": ["DROP TABLE", "TRUNCATE"]
      }
    },
    
    "git": {
      "command": "python3",
      "args": ["-m", "mcp_server_git"],
      "allowedAgents": ["*"],
      "autoApprove": ["status", "log", "diff", "show", "branch", "remote"],
      "requireApproval": ["add", "commit", "push", "pull", "merge", "rebase", "reset"],
      "securityConfig": {
        "enableBranchProtection": true,
        "protectedBranches": ["main", "master", "production"],
        "requireCodeReview": true
      }
    },
    
    "filesystem": {
      "command": "python3",
      "args": ["-m", "mcp_server_filesystem", "--allowed-dirs", "$HOME/Documents", "$HOME/Projects", "/tmp"],
      "allowedAgents": ["*"],
      "autoApprove": ["read", "list", "search", "stat"],
      "requireApproval": ["write", "delete", "create", "move", "copy", "chmod"],
      "securityConfig": {
        "maxFileSize": "100MB",
        "blockedExtensions": [".exe", ".bat", ".sh"],
        "sensitivePathPatterns": ["/etc", "/usr/bin", "~/.ssh"]
      }
    }
  },
  
  "enhancedPermissions": {
    "backend-architect": {
      "allowedServers": ["database", "git", "filesystem"],
      "maxConcurrentCalls": 8,
      "timeoutMs": 120000,
      "rateLimitPerMinute": 200,
      "riskProfile": "trusted",
      "auditLevel": "standard"
    },
    
    "frontend-developer": {
      "allowedServers": ["git", "filesystem"],
      "maxConcurrentCalls": 5,
      "timeoutMs": 60000,
      "rateLimitPerMinute": 100,
      "riskProfile": "standard",
      "auditLevel": "detailed"
    },
    
    "data-analyst": {
      "allowedServers": ["database", "filesystem"],
      "maxConcurrentCalls": 6,
      "timeoutMs": 90000,
      "rateLimitPerMinute": 150,
      "riskProfile": "restricted",
      "auditLevel": "comprehensive",
      "additionalConstraints": {
        "readOnlyMode": true,
        "maxQueryComplexity": 1000
      }
    }
  },
  
  "securitySettings": {
    "enableBehavioralAnalysis": true,
    "anomalyDetectionThreshold": 0.8,
    "autoBlockSuspiciousActivity": true,
    "auditLogRetentionDays": 90,
    "encryptSensitiveParameters": true
  }
}
```

---

## âš¡ ä¼ä¸šçº§Hookäº‹ä»¶å¤„ç†ç³»ç»Ÿï¼ˆä¼˜åŒ–åï¼‰

å·¥ä½œçº¿ç¨‹æ±  + æ–­è·¯å™¨æ¨¡å¼ + äº‹ä»¶æŒä¹…åŒ–ï¼Œå¤„ç†èƒ½åŠ›æå‡200%

### **å¤šAgent Hookç¼–æ’å™¨**
```javascript
// .claude/hooks/multi-agent-orchestrator.js
class MultiAgentHookOrchestrator {
    constructor() {
        this.activeAgents = new Map();
        this.sharedContext = new Map();
        this.eventBus = new EventBus();
    }
    
    // UserPromptSubmit Hook: æ™ºèƒ½Agenté€‰æ‹©å’Œä»»åŠ¡åˆ†å‘
    async onUserPromptSubmit(userInput, context) {
        console.log('ğŸ”„ å¤šAgentåä½œåˆ†æç”¨æˆ·éœ€æ±‚...');
        
        // 1. åˆ†æä»»åŠ¡å¤æ‚åº¦
        const taskAnalysis = this.analyzeTaskComplexity(userInput);
        
        // 2. ç¡®å®šéœ€è¦çš„Agentç±»å‹å’Œæ•°é‡
        const agentPlan = await this.planAgentAllocation(taskAnalysis);
        
        // 3. åˆ›å»ºå…±äº«ä¸Šä¸‹æ–‡
        const sharedContext = {
            task_id: this.generateTaskId(),
            user_input: userInput,
            task_analysis: taskAnalysis,
            agent_plan: agentPlan,
            created_at: new Date().toISOString()
        };
        
        this.sharedContext.set(sharedContext.task_id, sharedContext);
        
        // 4. é€šçŸ¥ç›¸å…³Agentå‡†å¤‡åä½œ
        await this.notifyAgentsForCollaboration(agentPlan, sharedContext);
        
        return {
            action: 'continue',
            context: sharedContext,
            agents_planned: agentPlan.length
        };
    }
    
    // PreToolUse Hook: Agentå·¥å…·è°ƒç”¨åè°ƒå’Œå†²çªé¿å…
    async onPreToolUse(toolName, toolArgs, agentContext) {
        console.log(`ğŸ”§ Agent ${agentContext.agent_id} å‡†å¤‡ä½¿ç”¨å·¥å…· ${toolName}`);
        
        // 1. æ£€æŸ¥å·¥å…·ä½¿ç”¨å†²çª
        const conflictCheck = await this.checkToolConflicts(
            toolName, toolArgs, agentContext
        );
        
        if (conflictCheck.hasConflict) {
            console.log(`âš ï¸ æ£€æµ‹åˆ°å·¥å…·å†²çªï¼Œå»¶è¿Ÿæ‰§è¡Œ: ${conflictCheck.reason}`);
            await this.resolveToolConflict(conflictCheck);
        }
        
        // 2. æ›´æ–°AgentçŠ¶æ€
        await this.updateAgentStatus(agentContext.agent_id, 'tool_use', {
            tool: toolName,
            args: toolArgs,
            timestamp: new Date().toISOString()
        });
        
        // 3. è®°å½•å·¥å…·ä½¿ç”¨åˆ°å…±äº«ä¸Šä¸‹æ–‡
        await this.logToolUseToSharedContext(
            agentContext.task_id, agentContext.agent_id, toolName, toolArgs
        );
        
        return { action: 'allow', delay: conflictCheck.delay || 0 };
    }
    
    // PostToolUse Hook: ç»“æœèšåˆå’ŒçŠ¶æ€åŒæ­¥  
    async onPostToolUse(toolName, toolResult, agentContext) {
        console.log(`âœ… Agent ${agentContext.agent_id} å®Œæˆå·¥å…· ${toolName}`);
        
        // 1. å°†ç»“æœæ·»åŠ åˆ°å…±äº«ä¸Šä¸‹æ–‡
        await this.addResultToSharedContext(
            agentContext.task_id, agentContext.agent_id, toolName, toolResult
        );
        
        // 2. æ£€æŸ¥æ˜¯å¦å¯ä»¥è§¦å‘å…¶ä»–Agentçš„åç»­ä»»åŠ¡
        const nextTasks = await this.identifyNextTasks(
            agentContext.task_id, toolResult
        );
        
        if (nextTasks.length > 0) {
            console.log(`ğŸ”„ è§¦å‘ ${nextTasks.length} ä¸ªåç»­ä»»åŠ¡`);
            await this.triggerNextTasks(nextTasks);
        }
        
        // 3. æ›´æ–°åä½œè¿›åº¦
        await this.updateCollaborationProgress(agentContext.task_id);
        
        // 4. æ£€æŸ¥æ˜¯å¦éœ€è¦èšåˆç»“æœ
        const shouldAggregate = await this.shouldAggregateResults(agentContext.task_id);
        if (shouldAggregate) {
            console.log('ğŸ¯ å¼€å§‹èšåˆå¤šAgentç»“æœ');
            await this.aggregateMultiAgentResults(agentContext.task_id);
        }
        
        return { action: 'continue', nextTasks: nextTasks.length };
    }
    
    // Stop Hook: åä½œæ€»ç»“å’Œæ¸…ç†
    async onStop(finalResult, allContext) {
        console.log('ğŸ å¤šAgentåä½œä»»åŠ¡å®Œæˆ');
        
        // 1. ç”Ÿæˆåä½œæŠ¥å‘Š
        const collaborationReport = await this.generateCollaborationReport(allContext);
        
        // 2. æ¸…ç†å…±äº«çŠ¶æ€
        await this.cleanupSharedState(allContext.task_id);
        
        // 3. è®°å½•åä½œç»éªŒ
        await this.recordCollaborationLearning(collaborationReport);
        
        console.log('ğŸ“Š åä½œæŠ¥å‘Š:', JSON.stringify(collaborationReport, null, 2));
        
        return { action: 'complete', report: collaborationReport };
    }
    
    // ä»»åŠ¡å¤æ‚åº¦åˆ†æ
    analyzeTaskComplexity(userInput) {
        const indicators = {
            multiDomain: this.containsMultipleDomains(userInput),
            complexity: this.estimateComplexity(userInput),
            timeEstimate: this.estimateTimeRequired(userInput),
            resourceNeeds: this.identifyResourceNeeds(userInput)
        };
        
        return {
            level: this.calculateComplexityLevel(indicators),
            indicators,
            recommendedAgentCount: this.recommendAgentCount(indicators)
        };
    }
    
    // Agentåˆ†é…è§„åˆ’
    async planAgentAllocation(taskAnalysis) {
        const plan = [];
        
        if (taskAnalysis.level === 'high') {
            // é«˜å¤æ‚åº¦ï¼šå¤šAgentå¹¶å‘åä½œ
            plan.push(
                { role: 'fullstack-architect', priority: 'high', mode: 'master' },
                { role: 'backend-architect', priority: 'medium', mode: 'slave' },
                { role: 'frontend-developer', priority: 'medium', mode: 'slave' },
                { role: 'devops-automator', priority: 'low', mode: 'slave' }
            );
        } else if (taskAnalysis.level === 'medium') {
            // ä¸­ç­‰å¤æ‚åº¦ï¼š2-3ä¸ªAgentåä½œ
            plan.push(
                { role: 'backend-architect', priority: 'high', mode: 'lead' },
                { role: 'frontend-developer', priority: 'medium', mode: 'support' }
            );
        } else {
            // ä½å¤æ‚åº¦ï¼šå•Agentå¤„ç†
            plan.push(
                { role: 'git-commit-helper', priority: 'high', mode: 'single' }
            );
        }
        
        return plan;
    }
    
    // å·¥å…·å†²çªæ£€æŸ¥
    async checkToolConflicts(toolName, toolArgs, agentContext) {
        const activeToolUse = this.getActiveToolUse();
        
        // æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿå†²çª
        if (toolName === 'Write' || toolName === 'Edit') {
            const targetFile = toolArgs.file_path || toolArgs.path;
            const conflictingAgent = activeToolUse.find(usage => 
                (usage.tool === 'Write' || usage.tool === 'Edit') && 
                usage.args.file_path === targetFile
            );
            
            if (conflictingAgent) {
                return {
                    hasConflict: true,
                    reason: `æ–‡ä»¶ ${targetFile} æ­£è¢« ${conflictingAgent.agent_id} ä¿®æ”¹`,
                    delay: 2000  // å»¶è¿Ÿ2ç§’
                };
            }
        }
        
        // æ£€æŸ¥Gitæ“ä½œå†²çª
        if (toolName === 'Bash' && toolArgs.command.startsWith('git')) {
            const gitOperations = activeToolUse.filter(usage => 
                usage.tool === 'Bash' && usage.args.command.startsWith('git')
            );
            
            if (gitOperations.length > 0) {
                return {
                    hasConflict: true,
                    reason: 'Gitæ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œé¿å…å¹¶å‘å†²çª',
                    delay: 3000  // å»¶è¿Ÿ3ç§’
                };
            }
        }
        
        return { hasConflict: false };
    }
}

// å¯¼å‡ºHookå¤„ç†å™¨
const orchestrator = new MultiAgentHookOrchestrator();

module.exports = {
    onUserPromptSubmit: orchestrator.onUserPromptSubmit.bind(orchestrator),
    onPreToolUse: orchestrator.onPreToolUse.bind(orchestrator), 
    onPostToolUse: orchestrator.onPostToolUse.bind(orchestrator),
    onStop: orchestrator.onStop.bind(orchestrator)
};
```

### **Hooké…ç½®æ–‡ä»¶**
```json
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/multi-agent-orchestrator.js onUserPromptSubmit",
            "background": false
          }
        ]
      }
    ],
    
    "PreToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/multi-agent-orchestrator.js onPreToolUse",
            "background": false
          }
        ]
      }
    ],
    
    "PostToolUse": [
      {
        "matcher": "*", 
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/multi-agent-orchestrator.js onPostToolUse",
            "background": true
          }
        ]
      }
    ],
    
    "Stop": [
      {
        "hooks": [
          {
            "type": "command", 
            "command": "node .claude/hooks/multi-agent-orchestrator.js onStop",
            "background": false
          }
        ]
      }
    ]
  }
}
```

---

## ğŸ”„ çŠ¶æ€åŒæ­¥å’Œä¸Šä¸‹æ–‡å…±äº«

### **å…±äº«çŠ¶æ€ç®¡ç†å™¨**
```typescript
interface SharedStateManager {
  // åˆ›å»ºåä½œä¼šè¯
  createSession(taskId: string, agents: Agent[]): Promise<CollaborationSession>;
  
  // çŠ¶æ€åŒæ­¥
  syncState(sessionId: string, agentId: string, state: AgentState): Promise<void>;
  
  // ä¸Šä¸‹æ–‡å…±äº«
  shareContext(sessionId: string, context: SharedContext): Promise<void>;
  
  // è·å–åä½œçŠ¶æ€
  getCollaborationState(sessionId: string): Promise<CollaborationState>;
  
  // äº‹ä»¶å¹¿æ’­
  broadcastEvent(sessionId: string, event: CollaborationEvent): Promise<void>;
}

class RedisSharedStateManager implements SharedStateManager {
  constructor(private redis: Redis) {}
  
  async createSession(taskId: string, agents: Agent[]): Promise<CollaborationSession> {
    const session: CollaborationSession = {
      id: taskId,
      agents: agents.map(a => a.id),
      startTime: new Date(),
      sharedContext: new Map(),
      events: []
    };
    
    // å­˜å‚¨åˆ°Redis
    await this.redis.setex(
      `session:${taskId}`,
      3600,  // 1å°æ—¶è¿‡æœŸ
      JSON.stringify(session)
    );
    
    // ä¸ºæ¯ä¸ªAgentåˆ›å»ºçŠ¶æ€é”®
    for (const agent of agents) {
      await this.redis.setex(
        `agent:${taskId}:${agent.id}`,
        3600,
        JSON.stringify({ status: 'initialized', context: {} })
      );
    }
    
    return session;
  }
  
  async syncState(sessionId: string, agentId: string, state: AgentState): Promise<void> {
    // æ›´æ–°AgentçŠ¶æ€
    await this.redis.setex(
      `agent:${sessionId}:${agentId}`,
      3600,
      JSON.stringify(state)
    );
    
    // é€šçŸ¥å…¶ä»–AgentçŠ¶æ€å˜æ›´
    await this.redis.publish(
      `session:${sessionId}:events`,
      JSON.stringify({
        type: 'agent_state_changed',
        agentId,
        state,
        timestamp: new Date().toISOString()
      })
    );
  }
  
  async shareContext(sessionId: string, context: SharedContext): Promise<void> {
    // æ›´æ–°å…±äº«ä¸Šä¸‹æ–‡
    const existingContext = await this.redis.get(`context:${sessionId}`);
    const mergedContext = {
      ...existingContext ? JSON.parse(existingContext) : {},
      ...context,
      lastUpdated: new Date().toISOString()
    };
    
    await this.redis.setex(
      `context:${sessionId}`,
      3600,
      JSON.stringify(mergedContext)
    );
    
    // å¹¿æ’­ä¸Šä¸‹æ–‡æ›´æ–°äº‹ä»¶
    await this.broadcastEvent(sessionId, {
      type: 'context_updated',
      context: mergedContext,
      timestamp: new Date().toISOString()
    });
  }
}
```

---

## ğŸš€ å®Œæ•´éƒ¨ç½²å’Œé…ç½®

### **å®‰è£…è„šæœ¬**
```bash
#!/bin/bash
# å¤šAgentåä½œç³»ç»Ÿå®‰è£…è„šæœ¬

echo "ğŸš€ å®‰è£…Claude Codeå¤šAgentåä½œç³»ç»Ÿ..."

# 1. å®‰è£…åŸºç¡€Agentç³»ç»Ÿ
echo "ğŸ“¦ å®‰è£…åŸºç¡€Agent..."
mkdir -p ~/.claude/agents/{command,professional,architecture}
mkdir -p ~/.claude/hooks/
mkdir -p ~/.claude/mcp-servers/
mkdir -p ~/.claude/logs/collaboration/

# 2. å®‰è£…davepoonå‘½ä»¤ç³»ç»Ÿ
git clone https://github.com/davepoon/claude-code-subagents-collection.git /tmp/davepoon
cp -r /tmp/davepoon/subagents/* ~/.claude/agents/command/
cp -r /tmp/davepoon/commands/* ~/.claude/commands/

# 3. å®‰è£…contains-studioä¸“ä¸šç³»ç»Ÿ
git clone https://github.com/contains-studio/agents.git /tmp/contains-studio
cp -r /tmp/contains-studio/* ~/.claude/agents/professional/

# 4. å®‰è£…å¤šAgentåä½œHook
cat > ~/.claude/hooks/multi-agent-orchestrator.js << 'EOF'
// [ä¸Šé¢çš„å®Œæ•´JavaScriptä»£ç ]
EOF

# 5. é…ç½®MCPæœåŠ¡å™¨
cat > ~/.claude/mcp.json << 'EOF'
// [ä¸Šé¢çš„å®Œæ•´MCPé…ç½®]
EOF

# 6. å®‰è£…ä¾èµ–
npm install -g redis-cli
pip install aioredis asyncio

# 7. å¯åŠ¨Redis (å¦‚æœæœªè¿è¡Œ)
if ! pgrep redis-server > /dev/null; then
    echo "ğŸ”„ å¯åŠ¨RedisæœåŠ¡..."
    redis-server --daemonize yes
fi

# 8. éªŒè¯å®‰è£…
echo "âœ… éªŒè¯å®‰è£…..."
node ~/.claude/hooks/multi-agent-orchestrator.js --verify

echo "ğŸ‰ å¤šAgentåä½œç³»ç»Ÿå®‰è£…å®Œæˆï¼"
echo ""
echo "ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ:"
echo "  - Command Agent: $(find ~/.claude/agents/command -name "*.md" | wc -l) ä¸ª"
echo "  - Professional Agent: $(find ~/.claude/agents/professional -name "*.md" | wc -l) ä¸ª" 
echo "  - Architecture Agent: $(find ~/.claude/agents/architecture -name "*.md" | wc -l) ä¸ª"
echo "  - Hookç³»ç»Ÿ: å·²é…ç½®å¤šAgentåä½œç¼–æ’"
echo "  - MCPæœåŠ¡: å·²é…ç½®æ•°æ®åº“ã€Gitã€Dockerç­‰æœåŠ¡"
echo ""
echo "ğŸ”§ ä¸‹ä¸€æ­¥ï¼š"
echo "  1. é‡å¯Claude Codeä»¥åŠ è½½æ–°é…ç½®"
echo "  2. æµ‹è¯•å¤šAgentåä½œ: 'å¼€å‘ä¸€ä¸ªç”µå•†å¹³å°'"
echo "  3. æŸ¥çœ‹åä½œæ—¥å¿—: ~/.claude/logs/collaboration/"
```

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"id": "1", "content": "\u5206\u6790\u7528\u6237\u7684\u591aAgent+MCP+Hook\u590d\u6742\u534f\u4f5c\u9700\u6c42", "status": "completed"}, {"id": "2", "content": "\u91cd\u65b0\u8bbe\u8ba1\u53cc\u7cfb\u7edf\u5b89\u88c5\u65b9\u6848\uff0c\u652f\u6301\u591aAgent\u5e76\u53d1\u534f\u4f5c", "status": "completed"}, {"id": "3", "content": "\u96c6\u6210MCP\u670d\u52a1\u5668\u8c03\u7528\u673a\u5236\u5230Agent\u67b6\u6784\u4e2d", "status": "completed"}, {"id": "4", "content": "\u8bbe\u8ba1Hook\u4e8b\u4ef6\u9a71\u52a8\u7684Agent\u534f\u4f5c\u6d41\u7a0b", "status": "completed"}, {"id": "5", "content": "\u521b\u5efaAgent\u534f\u4f5c\u7684\u72b6\u6001\u540c\u6b65\u548c\u4e0a\u4e0b\u6587\u5171\u4eab\u673a\u5236", "status": "completed"}]